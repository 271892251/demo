
/*
  localServer( port, root );

  提供了以下插件的中合体
  
  gulp-connect      <https://www.npmjs.com/package/gulp-connect>
  essi              <https://www.npmjs.com/package/essi>
  flex-combo        <https://www.npmjs.com/package/flex-combo>
  less              <https://www.npmjs.com/package/less>
  connect           <https://www.npmjs.com/package/connect>

*/

var connect = require("gulp-connect");
var fs = require("fs");
var essi = require("essi");
var flexCombo = require("flex-combo");
var less = require("less");

module.exports = function(port, root){


  // console.log( process.cwd() );

  prot = port || 3001;
  root = root ? root.replace(/^[\\/]/, "") : "";

  root = process.cwd()+"/" + root;


  connect.server({
    port: port,
    root: root,
    middleware:function(connect, app){

      return [
          // parseLessToCSS, 
          essi({
            strictPage: true,
            supportedFile:['.html']
          }),
          flexCombo({ rootdir:root, "dac/babel":{
            "target": ["pages/*.js"],
            "options": {
            }
          } })
      ]

    }
  });


  console.info("%s:%s", root, prot);


  // less to css
  function parseLessToCSS(req, res, next){

      var pathname = req._parsedUrl.pathname;
      if( /\.less\.css$/.test(pathname) ){
          
          fs.readFile(root+pathname.replace(".css",""), 'utf-8', function(err, data) {

            if (err) {
              //throw err 
              console.log(err);
              next();
              return ;
            }else{
              less.render(data, function(err, output) {
                res.setHeader("content-type","text/css");
                res.end( output );
              });
            }
        });
      }else{
        next();
      }
  }

}


