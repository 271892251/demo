
var initCanteen = {"data":{"when":{"id":"1","name":"\u672c\u90e8","breakfast_end":"39600","lunch_end":"39600","dinner_end":"0","school":"1","order":"0","status":"1","breakfast_order_end":"0","breakfast_send_start":"0","breakfast_send_end":"0","lunch_order_end":"0","lunch_send_start":"0","lunch_send_end":"0","dinner_order_end":"0","dinner_send_start":"0","dinner_send_end":"0"},"position":{"1":{"id":"1","name":"\u7f8e\u98df\u57ce\u9910\u5385","school_ext":"1","order":"0","status":"1","device":"4600403172044192","port":{"2":{"id":"2","name":"\u8bb8\u6751\u9762\u9986","image":"","canteen":"1","content":"","order":"0","status":"1"},"3":{"id":"3","name":"\u7802\u9505\u738b","image":"","canteen":"1","content":"","order":"0","status":"1"},"4":{"id":"4","name":"\u5c0f\u80a5\u725b\u62c9\u9762","image":"","canteen":"1","content":"","order":"0","status":"1"},"5":{"id":"5","name":"\u9ea6\u9999\u9986","image":"","canteen":"1","content":"","order":"0","status":"1"},"6":{"id":"6","name":"\u91cd\u5e86\u9ebb\u8fa3\u70eb","image":"","canteen":"1","content":"","order":"0","status":"1"},"7":{"id":"7","name":"\u5ddd\u5473\u9999\u9505","image":"","canteen":"1","content":"","order":"0","status":"1"},"8":{"id":"8","name":"\u5916\u5a46\u5bb6\u9762\u9986","image":"","canteen":"1","content":"","order":"0","status":"1"},"9":{"id":"9","name":"\u6e2f\u5f0f\u70e7\u814a","image":"","canteen":"1","content":"","order":"0","status":"1"},"10":{"id":"10","name":"\u946b\u946b\u7f8e\u98df\u574a","image":"","canteen":"1","content":"","order":"0","status":"1"},"11":{"id":"11","name":"\u9ec4\u7116\u9e21\u7c73\u996d","image":"","canteen":"1","content":"","order":"0","status":"1"},"12":{"id":"12","name":"\u571f\u8033\u5176\u70e4\u8089","image":"","canteen":"1","content":"","order":"0","status":"1"},"13":{"id":"13","name":"\u91d1\u8bb0\u4e00\u9505","image":"","canteen":"1","content":"","order":"0","status":"1"},"15":{"id":"15","name":"\u53f0\u5357\u5c0f\u94c1\u677f","image":"","canteen":"1","content":"","order":"0","status":"1"},"16":{"id":"16","name":"\u7f19\u4e91\u70e7\u997c","image":"","canteen":"1","content":"","order":"0","status":"1"},"17":{"id":"17","name":"\u82ad\u6bd4\u9992\u5934","image":"","canteen":"1","content":"","order":"0","status":"1"},"18":{"id":"18","name":"\u5112\u5bb6\u9999","image":"","canteen":"1","content":"","order":"0","status":"1"},"19":{"id":"19","name":"\u6816\u51e4\u6e21\u9c7c\u7c89","image":"","canteen":"1","content":"","order":"0","status":"1"},"20":{"id":"20","name":"\u9e2d\u5e97","image":"","canteen":"1","content":"","order":"0","status":"1"},"21":{"id":"21","name":"\u591a\u5473\u5c0f\u5403\u7ad9","image":"","canteen":"1","content":"","order":"0","status":"1"},"22":{"id":"22","name":"\u7f8e\u597d\u4e8b\u7269","image":"","canteen":"1","content":"","order":"0","status":"1"},"23":{"id":"23","name":"\u8425\u517b\u5957\u9910","image":"","canteen":"1","content":"","order":"0","status":"1"}}}}},"when":1,"canteen":"1","canteen_port":0,"len":0};
var initEleData = {"data":{"when":{"id":"1","name":"\u672c\u90e8","breakfast_end":"39600","lunch_end":"39600","dinner_end":"0","school":"1","order":"0","status":"1","breakfast_order_end":"0","breakfast_send_start":"0","breakfast_send_end":"0","lunch_order_end":"0","lunch_send_start":"0","lunch_send_end":"0","dinner_order_end":"0","dinner_send_start":"0","dinner_send_end":"0"},"dish":[{"id":"1","name":"\u9e21\u7c73\u82b1\u5957\u9910","image":"static/data/image/1.png","port":"1","money":"1100","content":"\u751f\u83dc+\u6cb9\u9ea6\u83dc+\u5343\u5f20+\u65e5\u672c\u8c46\u8150+\u5927\u8089\u4e32+QQ\u9762+\u6cb9\u6761+\u897f\u84dd\u82b1+\u51ac\u74dc","rest":"10000","rest_default":"100","breakfast":"2","lunch":"1","dinner":"1","create_time":"0","update_time":"0","order":"0","status":"0","total":"56"},{"id":"2","name":"\u9999\u80a0\u7092\u86cb\u5957\u9910","image":"static/data/image/1.png","port":"23","money":"1000","content":"","rest":"10000","rest_default":"100","breakfast":"2","lunch":"1","dinner":"1","create_time":"0","update_time":"0","order":"0","status":"1","total":"21"},{"id":"3","name":"\u91d1\u9488\u83c7\u725b\u67f3\u5957\u9910","image":"static/data/image/1.png","port":"23","money":"1200","content":"","rest":"10000","rest_default":"100","breakfast":"2","lunch":"1","dinner":"1","create_time":"0","update_time":"0","order":"0","status":"1","total":"23"},{"id":"4","name":"\u7ea2\u70e7\u8089\u5957\u9910","image":"static/data/image/1.png","port":"23","money":"1200","content":"","rest":"10000","rest_default":"100","breakfast":"2","lunch":"1","dinner":"1","create_time":"0","update_time":"0","order":"0","status":"1","total":"50"},{"id":"5","name":"\u7ea2\u70e7\u4ed4\u6392\u5957\u9910","image":"static/data/image/1.png","port":"23","money":"1200","content":"","rest":"10000","rest_default":"100","breakfast":"2","lunch":"1","dinner":"1","create_time":"0","update_time":"0","order":"0","status":"1","total":"79"},{"id":"6","name":"\u7ea2\u70e7\u8089\u5957\u9910","image":"static/data/image/1.png","port":"23","money":"12","content":"","rest":"10000","rest_default":"217","breakfast":"0","lunch":"1","dinner":"0","create_time":"0","update_time":"0","order":"0","status":"0","total":"0"},{"id":"7","name":"\u767d\u5207\u9e21\u5957\u9910","image":"static/data/image/1.png","port":"1","money":"1200","content":"+\u968f\u673a\u4e24\u7d20","rest":"10000","rest_default":"100","breakfast":"2","lunch":"1","dinner":"1","create_time":"0","update_time":"0","order":"0","status":"1","total":"23"},{"id":"8","name":"\u9999\u9165\u5927\u867e\u5957\u9910","image":"static/data/image/1.png","port":"1","money":"1300","content":"+\u968f\u673a\u4e24\u7d20","rest":"10000","rest_default":"100","breakfast":"2","lunch":"1","dinner":"1","create_time":"0","update_time":"0","order":"0","status":"0","total":"178"},{"id":"9","name":"\u9b54\u65b9\u9e21\u5757\u5957\u9910","image":"static/data/image/1.png","port":"1","money":"1200","content":"+\u968f\u673a\u4e24\u7d20","rest":"10000","rest_default":"100","breakfast":"2","lunch":"1","dinner":"1","create_time":"0","update_time":"0","order":"0","status":"1","total":"9"},{"id":"10","name":"\u9b54\u65b9\u9e21\u5757\u5957\u9910","image":"static/data/image/1.png","port":"1","money":"12","content":"","rest":"10000","rest_default":"5","breakfast":"0","lunch":"0","dinner":"0","create_time":"0","update_time":"0","order":"0","status":"0","total":"0"}]},"when":1,"canteen":"1","canteen_port":0,"len":10};

$(document).ready(function(ready) {
	var food_all_amount = 0					//初始菜数
	,	$order_list = $("#order-list")		//菜单列表
	,	$orderInfo = $("#order-icon")		//弹出式菜单icon & 当前总选菜数
	,	$container = $("#container")		//获取卡片容器
	,	$canteen = $("#canteen");			//选择餐厅

	/*********骚辉**********/
	//菜品生成
	var manageFood = {

		nowType : nowType - 1,
		hint : [ , "每日11:00前可预订当日午饭哦", "每日16:00前可预订当日晚饭哦" ],
		init : function(){

			//数据初始化
			// $.ajax({
			// 	type : "post",
			// 	url : "#",
			// 	data : {

			// 	},
			// 	success : function(data){

			// 	}
			// });
			
			//餐厅和档口初始化
			(function(data){
				var initCanteen = data.data.position;
				var resultCanteen = '';
				var resultCanteenPort = '';

				for( var i in initCanteen ){
					resultCanteen += '<li><a href="javascript:;">'+ initCanteen[i].name +'</a></li>';
					resultCanteenPort += '<div class="booth-ele"><ul>';

					for(var j in initCanteen[i].port){
						resultCanteenPort += '<li data-canteen="'
						+ initCanteen[i].id +'" data-canteen-port="'
						+ initCanteen[i].port[j].id +'"><a href="javascript:;">'
						+ initCanteen[i].port[j].name +'</a></li>';
					}
					resultCanteenPort += '</ul><div class="clear-float"></div></div>';
				}

				$("#restaurant ul").append( resultCanteen );
				$("#booth").append( resultCanteenPort );
				
				


				//切换档口
				var $restaurants = $("#restaurant a");
				for( var len = $restaurants.length; len--; ){
					(function(num){
						$($restaurants[num]).tap(function(e){
							$("#restaurant p").html( $(this).html() );
							$("#booth .booth-ele").css( 'display', 'none' );
							$( $("#booth .booth-ele")[num] ).css( 'display', 'block' );
							e.stopPropagation();
						});
					}(len));
				}
				var canPort = $("#booth a");
				for( var len = canPort.length; len--; ){
					(function(num){
						$(canPort[num]).tap(function(e){
							$("#booth p").html( $(this).html() );
							e.stopPropagation();
						});
					}(len));
				}

			}(initCanteen));


			(function(data){
				manageFood.nowType = data.when;
				manageFood.upload( data.data.dish );
			}(initEleData));
			
			//给 canteen 的 scroll 增加交互
			pageScoll( $("#canteen")[0], 5 );


			manageFood.cut( manageFood.nowType );

			manageFood.upTo( manageFood.nowType );

			//早餐午餐晚餐的时段切换菜单
			$("#tab li").tap(function(){
				var flag = $(this).attr('data-flag');
				//当data-flag的值为 'q' 时说明不允许访问
				if( flag == 'q' ){
					alert( $(this).children().children('span').html() + "此时段暂未开通" );
					return false;
				}
				//判断购物车是否为空，如果不为空则清空
				if( food_all_amount > 0 ){
					var temp = clearShopping('切换时间点将会清空购物车，您确定切换吗？');
					if(!temp)return;
				}
				manageFood.upTo(flag);
				manageFood.cut( flag );
				$("#tab li a").removeClass();
				$(this).children().addClass('current-time');
				manageFood.nowType = flag;
			}); 

			//初始化当前时间当前默认订餐时间的 active
			$("#tab li").eq( manageFood.nowType ).children('a').addClass( 'current-time' );

		},

		//菜品生成函数，一次生成一个页面上的 dom 
		//id:菜品的id
		//num：第几个菜品（早中晚分开）
		//img：菜品对应的链接
		//name：菜品名字
		//selNum：销量
		//cost：价格  imgSrc, name, sellNum, cost
		//{
		//		name : '晚餐'
		//		img : 'static/data/image/1.png',
		//		sellNum : 1024,
		//		cost : 12.5
		//},
		creatFood : function( data ){
			// console.log( data );
			return '<div class="card food row"  data-number="'+ data.id +'">\
			<img class="card-object	food-image  col-7" src="'+ data.image +'" >\
			<div class="card-text col-5"><ul class="food-info card-middle card-right large">\
			<li class="food-name icon-after" data-icon="HOT">'+ data.name +'</li>\
			<li class="food-components">'+ data.content +'</li>\
			<li class="food-sold icon-before" data-icon="店">'+ data.from +'</li>\
			<li class="food-sold icon-before" data-icon="售">'+ data.sellNum +'份</li>\
			<li class="food-unitprice warning">￥'+ data.money/1000 +'</li></ul>\
			</div><div class="card-box food-box"></div><div class="food-icon-group">\
			<div class="food-icon icon-plus-minus hidden minus" data-icon="-"></div>\
			<span class="food-amount hidden">0</span>\
			<div class="food-icon icon-plus-minus plus" data-icon="+"></div>\
			</div></div>';
		},

		//electTime：选择早上中午晚上。0：早上，1：中午，2：晚上
		cut : function( electTime ){
			
			$("#container").html('');

			//如果数据为空则发起请求
			if( initFood[electTime].length == 0 ){
				// 这里需要ajax请求一次
				return;
			}

			manageFood.append( initFood[electTime] );
		},

		//添加懂内容到可视区
		//data：对应添加的数据：早餐、午餐或晚餐的数组
		//start：为从data的第几个元素开始添加，也就是页面已有几个元素
		append : function( data ){
			var result = '';
			for( var i = 0, len = data.length ; i < len; i++ ){
				result += manageFood.creatFood( data[i] );
			}
			$("#container").append( result );
		},

		//用来把后台获取到的数据添加到食物数组
		upload : function ( data ){
			initFood[ manageFood.nowType ] = initFood[ manageFood.nowType ].concat(data);
			manageFood.append( data );
		},

		//首页提醒文字
		upTo : function ( flag ){
			$("#up_to").html( manageFood.hint[flag] );
		}
	};

	//数据自动更新
	dynamicLoad(function(){
		// $.ajax({
		// 	type : "post",
		// 	url : "#",
		// 	data : {

		// 	},
		// 	success : function(data){
		// 		data = eval( data );
		// 		manageFood.upload( data );
		// 	}
		// });
	});

	
	/*********END骚辉**********/


	$("#header").tap(function () {		//餐厅触发滑动
		slide($canteen).toggle();
	});



	/********骚辉更改***********/
	(function(){
		
		//菜单初始化
		var memu = {
			onOff : false,
			height : parseInt( $(".memu-pull-down li").css('height') ) * $(".memu-pull-down li").length,
			move :	function (e){

				if( this.onOff == false ){
					$(".memu-pull-down").css({
						'height' : this.height+'px',
					});
					this.onOff = true;
				} else {
					$(".memu-pull-down").css({
						'height' : '0',
					});
					this.onOff = false;
				}
				
			}
		}
		$("#memu").tap(function(e){
			memu.move();
			if( $( "#canteen" ).css('top') != '0px' ){
				e.stopPropagation();
			}
		});

		$(".memu-pull-down").tap(function(e){
			e.stopPropagation();
		});

		$(document).tap(function(){
			if( memu.onOff == true && $( "#canteen" ).css('top') == '0px' ){
				memu.move();
			}
		});
		

				
		
		manageFood.init();

			
	}());


	/**********END骚辉*****************/




	$("#order-icon").tap(function (ev) {	//购物车图标触发滑动
		var ev = ev || event;
		ev.preventDefault();
		slide($order_list).toggle();
	});

	$("#order-list-clear").tap(function(){
		clearShopping('您确定清空购物车吗？');
	});

	$("#order-enter").click(function () {
		var $order_input = $("#order-input")
		,	order = [];			//弹出式菜单————获取所有已选菜式的总价
		$order_list.find(".order-list-item").each(function () {
			order.push({
				amount : parseInt($(this).find(".item-food-amount").text()),
				id : $(this).attr("data-number")
			});
		});
		var result = {
			type :   manageFood.nowType + 1,
			data : order
		};
		var strResult = JSON.stringify(result);
		
		$order_input.val( strResult );
		return true;
	});
	$(document).on("tap", ".icon-plus-minus", function (ev) {
		var $that = $(this)
		,	$food_est = $that.closest(".food");

		var	type = $that.attr("data-icon");					//弹出式菜单————获取icon类型 用来判断+-号
		
		var $food = findFood($food_est);					//获取符合条件的菜式卡片和菜单条目
		if ($food.length > 1) {
			updateFood(type, $food);
		} else {
			if (type === "+")
				createItemDD($food_est);
		}
		updateOrderIcon();

		slide($order_list).update();
		coutTotal();
	});

	function clearShopping( msg ) {	//清空购物车
		var r = confirm( msg );
		if (!r) return false;

		$(".minus").addClass('hidden');
		$(".food-amount").addClass('hidden');
		if($order_list.css('top') != '0px'){
			slide($order_list).toggle();
		}
		$order_list.find(".food").remove();
		$container.find(".food-amount").html("0");

		food_all_amount = 0;
		updateOrderIcon();
		coutTotal();

		return true;
	}


	function createItemDD (food) {
		var	$food_name = food.find(".food-name")	
		,	$food_unitprice = food.find(".food-unitprice")
		,	$food_minus = food.find(".minus")
		,	$food_amount = food.find(".food-amount");

		var	food_number = food.attr("data-number")
		,	food_unitprice = $food_unitprice.text()
		,	food_name = $food_name.text();
		var html = '<dd class="order-list-item food" data-number="' + food_number + '"data-unitprice="' + food_unitprice + '">'
				 + '<span class="food-name">' + food_name + '</span>'
				 + '<div  class="item-food-icon icon-plus-minus float-right plus" data-icon="+"></div>'
				 + '<span class="item-food-amount float-right">' + 1 + '</span>'
				 + '<div  class="item-food-icon icon-plus-minus float-right minus" data-icon="-"></div>'
				 + '<span class="item-food-total float-right" >' + food_unitprice + '</span>'
				 + '</dd>';
		food_all_amount++;
		$food_minus.removeClass("hidden");
		$food_amount.removeClass("hidden");
		$food_amount.html("1");
		$("#order-list-title").after(html); //弹出式菜单标题
	}
	function updateOrderIcon () {
		$orderInfo.attr("data-icon",food_all_amount);		//更新icon总菜式数量
	}
	function updateFood (type, food) {
		var	$food_amount = food.find(".food-amount")				//卡片菜式显示的数量-对象获取
		,	$item_food_total = food.find(".item-food-total")		//弹出式菜单-当前选取菜式的总价-对象获取
		,	$item_food_amount = food.find(".item-food-amount")		//弹出式菜单-当前选取菜式的数量-对象获取

		var amount = parseInt($item_food_amount.text());
		if (type === "+") {
			amount++;
			food_all_amount++;
		} else if (type === "-") {
			if (amount === 1) {
				food.filter(".order-list-item").remove();
				var $card_food = food.filter(".card");
				$card_food.find(".minus").addClass("hidden");
				$card_food.find(".food-amount").addClass("hidden");
				slide($order_list).update();
			}
			amount--;
			food_all_amount--;
		} else {
			return;
		}

		var	unitprice = parseFloat(food.find(".food-unitprice").text().match(/\d+(\.\d+)?$/g));//获取单价
		var price = unitprice * amount;

		$food_amount.html(amount);							//卡片-当前选取菜式数量-更新
		$item_food_amount.html(amount);						//弹出式菜单-当前选取菜式数量-更新
		$item_food_total.html("￥" + price.toFixed(1));	//弹出式菜单-当前选取菜式总价-更新
	}
	function findFood (obj) {
		var number = obj.attr("data-number");	//当前选择的菜的编号

		var $dd = $(".food").filter(function () {
			return $(this).attr("data-number") === number;
		});	
		return $dd;
	}
	function coutTotal () {
		var $order_price = $("#order-price")
		,	total = 0;			//弹出式菜单————获取所有已选菜式的总价

		$order_list.find(".item-food-total").each(function () {
			total += parseFloat($(this).text().match(/\d+(\.\d+)?$/g));
		});
		$order_price.html("￥" + total.toFixed(1));

		var $order_enter = $("#order-enter");
		if (total >= 6) {
			$("#order-enter").html( '确认购买' );
			$order_enter.removeAttr("disabled");
			$order_enter.css("backgroundColor","#ff6550");
		} else {
			$("#order-enter").html( '6元起送' );
			$order_enter.attr("disabled","disabled");
			$order_enter.css("backgroundColor","#888");
		}
	}

	function slide(obj) {
		var $obj = obj;
	
		return {
			toggle : function () {
				var	height = $obj.height()
				,	dist = $obj.css("top") === '0px' ? (-height + 'px') : '0px';
				$obj.css("top", dist);
			},
			update : function () {
				var	height = $obj.height()
				,	dist = $obj.css("top") === '0px' ? '0px' : (-height + 'px');
				$obj.css("top", dist);
			}
		};
	}
});